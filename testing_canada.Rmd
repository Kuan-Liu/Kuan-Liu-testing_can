---
title: "COVID-19 Testing Data and Trend in Canada"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
author: 
- "Kuan Liu, kuan.liu@mail.utoronto.ca"
- "Alexandra Bushby, alex.bushby@mail.utoronto.ca"
- "Thai-Son Tang, thaison.tang@mail.utoronto.ca"

output:
  html_document:
    keep_md: true
    highlight: haddock
    number_sections: false
    self_contained: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

**Date Created:** Mar 25, 2020

**Date Updated:** `r format(Sys.time(), "%b %d, %Y %X EDT")`

**Code Avaliable at** https://github.com/Kuan-Liu/Kuan-Liu-testing_can

```{r setup, echo=FALSE, results='none', message = FALSE, warning = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, fig.align = "center",fig.height = 6, fig.width = 8)
options(knitr.kable.NA = '-')
### Here, I'm using packman package to load packages if not currently available 
require(ggplot2)
library("knitr")
library("magick")
library("chron")
library(tidyverse)
library(ggpol)
library(dplyr)
```


**From the authors: Thank you for your interest in our work! We are constantly working to improve this website and all comments and feedbacks are welcome. For most accurate and reliable Canadian COVID-19 epidemiology data, please visit Public Health Agency of Canada COVID-19 report site at https://www.canada.ca/en/public-health/services/diseases/2019-novel-coronavirus-infection.html (Full PDF report available).**

**Update: starting April 4, we will report Ontario case number using the COVID-19 Canada Open Data Working Group's spreadsheet. The data is updated using information from Ontario public health units and the numbers on case count may be higher than other sources.**

## Acknowledgment
Data used in this repostory are extracted from the data speardsheet posted by the COVID-19 Canada Open Data Working Group (https://github.com/ishaberry/Covid19Canada). This working group, lead by Isha Berry and Jean-Paul R. Soucy from Dalla Lana School of Public Health, Unviersity of Toronto, has created an interactive dashboard on Canadian COVID-19 epidemiology data. We direct readers to visit the dashboard at https://art-bd.shinyapps.io/covid19canada/.

## 1. Objectives and key messages
 - Providing information on testing capacity and trend overtime in Canada to **identify gaps and needs to increase testing capacity**.
 - Providing information on testing results, sepcifcially the proporion of patients reported positive, to **provide inslight on testing protocols**. When testing resources are limited, protocols to grant testing are likely to be modified to maximize health outcomes. For instance, symptomatic patients in high risk group for severe outcomes are given testing priority.

## 2. Total number of tests to date

<!-- ### 2.1 Nation-wide total number of tests to date -->

<!-- As of March 30, 2020 (6 pm EDT), the total number of patients tested in Canada is **184,201** and the total number of patients tested per 100,000 population in Canada is around **490**. -->

<!--   - the total number of patients tested positive is **5,153 (2.8%)** -->
<!--   - the total number of patients tested negative is **166,621 (90.5%)** -->
<!--   - the rest **12,427 (6.7%)** patients are likely under investigation waiting for test results, detailed information is not available. -->

### 2.1 Total number of tests to date by province and territory

- **Highlights**
  - **Alberta, Quebec and Saskatchewan are the top three provinces ranking by the number of tests per 100,000 population.**
  - **Quebec has rapidly increased its testing capacity. The total number of tests per 100,000 population has increased to 1375 as of Apr 8, 2020, comparing to 365 on Mar 25, 2020.**
  - **Northwest territories and Yukon reported over 1800 tests per 100,000 population, highest in Canada.**

```{r echo=FALSE}
#getting a pretty pyramid plot;
testing_todate <- read.table("C:/Users/kuan liu/Dropbox (Personal)/STAT_consulting/Bayesiantest/Kuan-Liu-testing_can/Kuan-Liu-testing_can/testing_todate.txt", header=FALSE, sep="\t")
# testing_todate <- read.table("testing_todate.txt", header=FALSE, sep="\t")
names(testing_todate)[1:7]<-c("Province","Reported Positive","Reported Negative","Reported Pending","Total","Est. Population","Total per 100,000 population")

testing_todate_p<-testing_todate[testing_todate$Province %in% c("AB","BC","MB","NB","NL","NS","ON","PE","QC","SK"),]
testing_todate_t<-testing_todate[testing_todate$Province %in% c("NT","YT","NU"),]

testing_todate_p<-testing_todate_p[order(testing_todate_p$`Total per 100,000 population`, decreasing = TRUE),]
testing_todate_t<-testing_todate_t[order(testing_todate_t$`Total per 100,000 population`, decreasing = TRUE),]
names(testing_todate_t)[1:7]<-c("Territory","Reported Positive","Reported Negative","Reported Pending","Total","Est. Population","Total per 100,000 population")

# 1.Create Dataset;
testing_todate_pcum<-data.frame(testing_todate_p$Province, -testing_todate_p$Total, "Total tests")
testing_todate_pcump<-data.frame(testing_todate_p$Province, testing_todate_p$`Total per 100,000 population`, "Total tests per 100,000 population")
names(testing_todate_pcum)<-c("Province","Total","Data")
names(testing_todate_pcump)<-c("Province","Total","Data")
testing_todate_plot_p<-rbind(testing_todate_pcum,testing_todate_pcump)

testing_todate_tcum<-data.frame(testing_todate_t$Territory, -testing_todate_t$Total, "Total tests")
testing_todate_tcump<-data.frame(testing_todate_t$Territory, testing_todate_t$`Total per 100,000 population`, "Total tests per 100,000 population")
names(testing_todate_tcum)<-c("Territory","Total","Data")
names(testing_todate_tcump)<-c("Territory","Total","Data")
testing_todate_plot_t<-rbind(testing_todate_tcum,testing_todate_tcump)


dfp <- tibble(
  Total = testing_todate_plot_p$Total,
  Data = testing_todate_plot_p$Data,
  Province = testing_todate_plot_p$Province
  )


dft <- tibble(
  Total = testing_todate_plot_t$Total,
  Data = testing_todate_plot_t$Data,
  Territory = testing_todate_plot_t$Territory
  )

cump<-ggplot(dfp, aes(x = forcats::fct_rev(Province), y = Total, fill = Data)) +
  geom_bar(stat = "identity", position = position_dodge(width=-0.5), width = 0.8, colour="black") +
  # geom_text(size = 3, stat = 'identity', 
  #           aes(label=c(testing_todate_p$Total,testing_todate_p$`Total per 100,000 population` ), hjust=c(rep(1.2,10),rep(-0.2,10)))) +
  facet_share(~Data, dir = "h", scales = "free", reverse_num = TRUE) +
  coord_flip() + 
  labs(y = "", x = " ", title = paste("As of ", format(Sys.time(), "%b %d, %Y %X"))) +
  scale_fill_manual(values = c("lightblue", "orange"))+
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        panel.grid.major = element_line(colour = "grey95"),
        panel.grid.minor = element_line(colour = "grey95"), 
        legend.position = "none",
        axis.title = element_text(size=11))

cumt<-ggplot(dft, aes(x = forcats::fct_rev(Territory), y = Total, fill = Data)) +
  geom_bar(stat = "identity", position = position_dodge(width=-0.5), width = 0.8, colour="black") +
  # geom_text(size = 3, stat = 'identity', 
  #           aes(label=c(testing_todate_p$Total,testing_todate_p$`Total per 100,000 population` ), hjust=c(rep(1.2,10),rep(-0.2,10)))) +
  facet_share(~Data, dir = "h", scales = "free", reverse_num = TRUE) +
  coord_flip() + 
  labs(y = "", x = " ") +
  scale_fill_manual(values = c("lightblue", "orange"))+
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        panel.grid.major = element_line(colour = "grey95"),
        panel.grid.minor = element_line(colour = "grey95"), 
        legend.position = "none",
        plot.title = element_blank(),
        axis.title = element_text(size=11))

cowplot::plot_grid(cump, cumt, nrow=2, rel_heights = c(0.7,0.3),align = "v")

```  

```{r results='asis', echo=FALSE}
# testing_todate<-rbind(testing_todate_p,testing_todate_t)
kable(testing_todate_p[,1:7], caption = paste("Reported testing data province and territory, public data accessed online as of ", format(Sys.time(), "%b %d, %Y %X")), row.names = FALSE, align=c("c","c","c","c","c","c","c"))
kable(testing_todate_t[,1:7], row.names = FALSE,align=c("c","c","c","c","c","c","c"))

```

###### Footnote: It's likely individuals may have been tested more than once. We are collecting publicly avaliable information online to best match patients with testing numbers. Unfortunately, detailed information is not always avaiable, so please read these data with caution. Reported positive tests include resolved and deceased cases.


### 2.2 Relation between cases and tests

#### Geographic mapping on the total number of tests, total number of cases, total number of tests per 100,000 population and total number of cases per 100,000 population as of `r format(Sys.time(), "%b %d, %Y %X")`
```{r echo=FALSE,results='hide',message = FALSE, warning = FALSE}
# install.packages("tmap")
# install.packages("tmaptools")
# install.packages("leaflet")
# install.packages("rgdal")
library("tmap")
library("tmaptools")
library("leaflet")
library("rgdal")

mapstat<-read.table("C:/Users/kuan liu/Dropbox (Personal)/STAT_consulting/Bayesiantest/Kuan-Liu-testing_can/Kuan-Liu-testing_can/testing_mapsdata.txt", header = TRUE, sep="\t")

## for alex's use:
# mapstat <- read.table("testing_mapsdata.txt", header = TRUE, sep="\t")
# canada_prov <- readOGR(dsn = "Kuan-Liu-testing_can", encoding='UTF-8',layer = "Canada")

canada_prov <- readOGR(dsn = "C:/Users/kuan liu/Dropbox (Personal)/STAT_consulting/Bayesiantest/Kuan-Liu-testing_can/Kuan-Liu-testing_can",
                       encoding='UTF-8',layer = "Canada")

canada_prov$id<-c(24, 12, 47, 48, 10, 59, 13, 11, 60, 46, 35, 62, 61)
testing_data<-merge(canada_prov, mapstat, by="id")

map_test = tm_shape(testing_data)+tm_polygons(col="test",breaks=c(0,5000,10000,50000,100000, Inf),labels = c("<5000", "5000-10000", "10000-50000","50000-100000",">100000"), title=" ",palette ="YlOrRd")+tm_layout(title="Tests", title.size = 1,title.position=c("left","bottom"),legend.position = c(0.73,0.7))

#map stat can be grouped with fixed breaks or continuous, 
map_case = tm_shape(testing_data)+tm_polygons(col="case",breaks=c(0,1,100,500,1000,2000,5000,Inf),labels = c("0", "1-100","100-500","500-1000","1000-2000","2000-5000",">5000"),title=" ",palette ="YlOrRd")+tm_layout(title="Cases", title.size = 1,title.position=c("left","bottom"),legend.position =c(0.77,0.63))

map_test_p = tm_shape(testing_data)+tm_polygons(col="test_pop",breaks=c(500,1000,1500,3000,Inf),labels = c("500-1000","1000-1500","1500-3000",">3000"), title=" ",palette ="YlOrRd")+tm_layout(title="Tests per 100,000", title.size = 1,title.position=c("left","bottom"),legend.position =c(0.78,0.76))

map_case_p = tm_shape(testing_data)+tm_polygons(col="case_pop",breaks=c(0,1,20,30,40,50,Inf),labels = c("0", "1-20", "20-30","30-40","40-50",">50"), title=" ",palette ="YlOrRd")+tm_layout(title="Cases per 100,000", title.size = 1,title.position=c("left","bottom"),legend.position = c(0.84,0.68))

tmap_arrange(map_test, map_case,map_test_p, map_case_p,nrow=2,ncol=2)

# png("test-case_map.png")
# tmap_arrange(map_test_p, map_case_p,nrow=1,ncol=2)
# dev.off()

```

### 2.3 Estimated Test-Case Ratio
We define the test-case ratio (TCR) as
$$
TCR= \frac{\text{Total number of postive cases}}{\text{Total number of tests completed}},
$$
which is also known as the proportion of positives cases. For provinces and territories that reported total number of tests including under investigation tests. The demoninator has be asjusted to inclunde only the completed, results known tests.

**Interpretation: Provinces and territories above the national line demonstrate higher proportion of tested inidividuals being postive - individuals tested in these areas are relatively more likely to be positive; Similarly, provinces and territories below the national line demonstrate lower proportion of tested individuals being positive - individuals tested in these areas are relatively less likely to be positive.**

```{r echo=FALSE,results='hide',message = FALSE, warning = FALSE}
library(gridExtra)
library(ggthemes)
library(dichromat)
library(directlabels)

testing_todate$caseperpop<-round(testing_todate$`Reported Positive`/testing_todate$`Est. Population`*100000,0)
names(testing_todate)[8]<-"Total cases per 100,000"

#scale_colour_colorblind only contents 8 discrete colours, we have 10 provinces so I used the same colour pallete code but added to more colours =);
teamcolour<-c("#000000","#E69F00","#800000","#CC79A7","#56B4E9","#808000","#625D5D","#1589FF","#009E73","#0000A0","#0072B2","#800080","#E56717")
teamcolour_territory<-c("#625D5D","#1589FF","#E56717")
teamcolour_province<-c("#000000","#E69F00","#800000","#CC79A7","#56B4E9","#808000","#009E73","#0000A0","#0072B2","#800080")

#estimate national testing-case ratio;
testing_todate$total_adj<-ifelse(is.na(testing_todate$`Reported Pending`)==1,testing_todate$Total, testing_todate$Total- testing_todate$`Reported Pending`)
TCR_CAN<- round(sum(testing_todate$`Reported Positive`)/sum(testing_todate$total_adj),2)
testing_todate$total_adjp<-round(testing_todate$total_adj/testing_todate$`Est. Population`*100000,0)
# TCR_NY<- round(59513/172360,2)


#cases/100,000 and tests/100,000;
ggplot(testing_todate, aes(x=total_adjp, y=`Total cases per 100,000`, colour=Province)) +
  geom_point(size=3)+geom_text(aes(fontface=2, label=Province), hjust=-0.1,vjust=-0.5,show.legend=FALSE)+
  geom_abline(intercept = 0, slope = TCR_CAN, color="red", 
                 linetype="dashed", size=1.5)+
  annotate(geom="text", x=300, y=120, label=paste("national test-case ratio at ", TCR_CAN*100 ,"%"),
              color="red") +
  # geom_abline(intercept = 0, slope = TCR_NY, color="blue", 
  #                linetype="dashed", size=1.5)+
  # annotate(geom="text", x=1200, y=22, label="NY state test-case ratio at 35%",
  #             color="blue") +
  scale_x_continuous(limits = c(0, 1700), breaks = seq(0,1700,200))+
  scale_y_continuous(limits = c(0, 120), breaks = seq(0,120,10))+
  scale_color_manual(values=teamcolour)+
  labs(y="\n Total cases per 100,000 popualtion", x=" \n Total tests per 100,000 population",title = paste("Cases per 100,000 by tests per 100,000, as of ", format(Sys.time(), "%b %d, %Y %X") ))+
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        panel.grid.major = element_line(colour = "grey95"),
        panel.grid.minor = element_line(colour = "grey95"),
        axis.text=element_text(size=11),
        legend.position =  "right",
        legend.background = element_blank(),
        legend.box.background = element_blank(),
        legend.title = element_blank(),
        legend.key = element_blank(),
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)))  



```

## 3. Cumulative tests overtime

- **Highlights**
  - **Consistent increase of testing capacity overtime across Canada.**   
  - **Quebec displays a sharp testing increase on March 25, 2020. British Columbia displays a shart testing increase on March 20, 2020.**
  - **Alberta, Ontario, British Columbia and Quebec are the top 4 provinces ranked by the total number of cumulative tests with Quebec as the leading province**
  - **It seems Ontario is falling slight behind on the testing capacity per capita. **

```{r echo=FALSE,message = FALSE, warning = FALSE}
library(gganimate)
library(devtools)
library(reshape2)

testing_cum <- read.table("C:/Users/kuan liu/Dropbox (Personal)/STAT_consulting/Bayesiantest/Kuan-Liu-testing_can/Kuan-Liu-testing_can/testing_cumulative.txt", header=TRUE, sep="\t")

# for Alex's purposes:
## testing_cum <- read.table("testing_cumulative.txt", header=TRUE, sep="\t")

names(testing_cum)<-c("dateformat","Province","cumulative","population")
testing_cum$dateformat<-chron(as.character(testing_cum$dateformat),format="d-m-y",out.format="month-d-y")
testing_cum$dateformat<-as.Date(testing_cum$dateformat)

  
## bar plot on testing for different Provinces/Territories
### turning "NA" into 0
testing_cum[is.na(testing_cum)] <- 0
### adding a column of ranks for each day:
new.testing_cum <- testing_cum %>%
  group_by(dateformat) %>%
  # The * 1 makes it possible to have non-integer ranks while sliding
  mutate(Rank = rank(-cumulative),
         Value_rel = cumulative/cumulative[Rank == 1],
         Value_lbl = paste0(" ", round(cumulative))) %>%
  group_by(Province) %>% 
  ungroup()

p1<-ggplot(new.testing_cum, aes(x = Rank, group = Province, 
                fill = as.factor(Province), colour =  as.factor(Province))) +
  geom_tile(aes(y = cumulative/2,
                height = cumulative,
                width = 0.9), alpha = 0.8, colour =  NA) +
  scale_color_manual(values=c(teamcolour),aesthetics = c("colour", "fill")) +
  geom_text(aes(y = 0, label = paste(Province, " ")), vjust = 0.2, hjust = 1) +
  geom_text(aes(y = cumulative, label = Value_lbl, hjust=0)) +
  coord_flip(clip = "off", expand = FALSE) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_reverse() +
  guides(color =FALSE, fill = FALSE) +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position="none",
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.grid.major.x = element_line( size=.1, color="grey" ),
        panel.grid.minor.x = element_line( size=.1, color="grey" ),
        plot.title=element_text(size=25, hjust=0.5, face="bold", colour="grey", vjust=-1),
        plot.subtitle=element_text(size=15, hjust=0.5, face="italic", color="black"),
        plot.caption =element_text(size=8, hjust=0.5, face="italic", color="grey"),
        plot.background=element_blank(),
       plot.margin = margin(1,2, 1, 2, "cm")) + 
  gganimate::transition_states(dateformat, transition_length = 8, state_length = 8) +
  view_follow(fixed_x = TRUE)  +
  labs(subtitle = 'Total number of cumulative tests \n by province and territory \n {closest_state}')

#plot of per capita;
testingprop_cum<-data.frame(testing_cum[,1:2],round(testing_cum[,3]/testing_cum[,4]*100000,0))
names(testingprop_cum)<-c("dateformat","Province","cumulativecapita")
## bar plot on testing for different Provinces/Territories
### turning "NA" into 0
testingprop_cum[is.na(testingprop_cum)] <- 0
### adding a column of ranks for each day:
new.testingprop_cum <- testingprop_cum %>%
  group_by(dateformat) %>%
  # The * 1 makes it possible to have non-integer ranks while sliding
  mutate(Rank = rank(-cumulativecapita),
         Value_rel = cumulativecapita/cumulativecapita[Rank == 1],
         Value_lbl = paste0(" ", round(cumulativecapita))) %>%
  group_by(Province) %>% 
  ungroup()

p2<-ggplot(new.testingprop_cum, aes(x = Rank, group = Province, 
                fill = as.factor(Province), colour =  as.factor(Province))) +
  geom_tile(aes(y = cumulativecapita/2,
                height = cumulativecapita,
                width = 0.9), alpha = 0.8, colour =  NA) +
  scale_color_manual(values=c(teamcolour),aesthetics = c("colour", "fill")) +
  geom_text(aes(y = 0, label = paste(Province, " ")), vjust = 0.2, hjust = 1) +
  geom_text(aes(y = cumulativecapita, label = Value_lbl, hjust=0)) +
  coord_flip(clip = "off", expand = FALSE) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_reverse() +
  guides(color =FALSE, fill = FALSE) +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position="none",
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.grid.major.x = element_line( size=.1, color="grey" ),
        panel.grid.minor.x = element_line( size=.1, color="grey" ),
        plot.title=element_text(size=25, hjust=0.5, face="bold", colour="grey", vjust=-1),
        plot.subtitle=element_text(size=15, hjust=0.5, face="italic", color="black"),
        plot.caption =element_text(size=8, hjust=0.5, face="italic", color="grey"),
        plot.background=element_blank(),
       plot.margin = margin(1,2, 1, 2, "cm")) + 
  gganimate::transition_states(dateformat, transition_length = 8, state_length = 8) +
  view_follow(fixed_x = TRUE)  +
  labs(subtitle = 'Total number of cumulative tests per 100,000 \n by province and territory \n {closest_state}')

p1
p2
```

```{r echo=FALSE}

testing_cum2<-subset(testing_cum, Province %in% c("AB","BC","MB","NB","NL","NS","ON","PE","QC","SK"))

p_testcum<-ggplot(testing_cum2, aes(x=dateformat, y=cumulative, colour=Province)) +
geom_line(size = 1)+geom_point()+
  scale_y_continuous(limits = c(0, 120000), breaks = seq(0,120000,5000))+
  scale_color_manual(values=teamcolour_province)+
  # scale_colour_brewer(palette="Spectral",direction=-1)+
  scale_x_date(date_breaks="1 day",date_labels="%b %d", 
               limits = c(min(testing_cum2$dateformat), max(testing_cum2$dateformat) + 0.25)) +
  labs(y="\n Total number of cumulative tests by province", x="")+
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        panel.grid.major = element_line(colour = "grey95"),
        #panel.grid.minor = element_line(colour = "grey95"), 
        axis.text=element_text(size=11),
        axis.text.x = element_text(angle = 45, hjust = 1),
        #legend.background = element_blank(),
        #legend.key = element_blank(),
        #legend.title = element_blank(), 
        legend.position = "none",
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) + 
  geom_dl(aes(label = Province), method = list(dl.trans(x = x + 0.2), "last.qp"))

p_testcum

testprop_cum<-data.frame(testing_cum[,1:2],round(testing_cum[,3]/testing_cum[,4]*100000,1))
names(testprop_cum)<-c("dateformat","Province","cumulative_p")
testprop_cum2<-subset(testprop_cum, Province %in% c("AB","BC","MB","NB","NL","NS","ON","PE","QC","SK"))


p_testcump<-ggplot(testprop_cum2, aes(x=dateformat, y=cumulative_p, colour=Province)) +
geom_line(size = 1)+geom_point()+
  # geom_hline(yintercept=590, linetype="dashed", color = "black") +
  # geom_text(x=as.Date("2020-03-16"),y=510,label="Mar 28 National est.",color="black")+
  scale_y_continuous(limits = c(0, 1800), breaks = seq(0,1800,100))+
  scale_color_manual(values=teamcolour_province)+
  scale_x_date(date_breaks="1 day",date_labels="%b %d")+
  labs(y="\n Total number of cumulative tests per 100,000 population \n by province", x="")+
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        panel.grid.major = element_line(colour = "grey95"),
        #panel.grid.minor = element_line(colour = "grey95"), 
        axis.text=element_text(size=11),
        axis.text.x = element_text(angle = 45, hjust = 1),
        #legend.background = element_blank(),
        #legend.key = element_blank(),
        #legend.title = element_blank(),
        legend.position = "none",
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) + 
  geom_dl(aes(label = Province), method = list(dl.trans(x = x + 0.2), "last.qp"))


p_testcump
```

```{r echo=FALSE}

testing_cum2<-subset(testing_cum, Province %in% c("NU","YT","NT") & dateformat > as.Date("2020-03-16"))

p_testcumt<-ggplot(testing_cum2, aes(x=dateformat, y=cumulative, colour=Province)) +
geom_line(size = 1)+geom_point()+
  scale_y_continuous(limits = c(0, 1500), breaks = seq(0,1500,200))+
  scale_color_manual(values=teamcolour_territory)+
  scale_x_date(date_breaks="1 day",date_labels="%b %d")+
  labs(y="\n Total number of cumulative tests \n by territory", x="")+
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        panel.grid.major = element_line(colour = "grey95"),
        #panel.grid.minor = element_line(colour = "grey95"), 
        axis.text=element_text(size=11),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.title = element_blank(),
        legend.position = "none",
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) + 
  geom_dl(aes(label = Province), method = list(dl.trans(x = x + 0.2), "last.qp"))

testprop_cum<-data.frame(testing_cum[,1:2],round(testing_cum[,3]/testing_cum[,4]*100000,1))
names(testprop_cum)<-c("dateformat","Province","cumulative_p")
testprop_cum2<-subset(testprop_cum, Province %in% c("NU","YT","NT") & dateformat > as.Date("2020-03-16"))

p_testcumpt<-ggplot(testprop_cum2, aes(x=dateformat, y=cumulative_p, colour=Province)) +
geom_line(size = 1)+geom_point()+
  # geom_hline(yintercept=500, linetype="dashed", color = "black") +
  scale_y_continuous(limits = c(0, 3500), breaks = seq(0,3500,500))+
  scale_color_manual(values=teamcolour_territory)+
  scale_x_date(date_breaks="1 day",date_labels="%b %d")+
  labs(y="\n Total number of cumulative tests \n per 100,000 population by territory", x="")+
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        panel.grid.major = element_line(colour = "grey95"),
        #panel.grid.minor = element_line(colour = "grey95"), 
        axis.text=element_text(size=11),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.title = element_blank(),
         legend.position = "none",
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) + 
  geom_dl(aes(label = Province), method = list(dl.trans(x = x + 0.2), "last.qp"))

cowplot::plot_grid(p_testcumt, p_testcumpt, nrow=2, rel_heights = c(0.5,0.5), align = "v")

```



## 4. Tests completed per day 

- **Highlights**
  - **Quebec has increased its testing capacity on March 22, 2020 to allow the direct inclusion of hospital laboratories' testing results. This explains the observed dramatic increase on the number of tests completed on March 24, 2020. It's likely these additional tests reported on that day were completed over the past two days.**
  - **The number of tests completed per day does NOT directly reflect regional testing capacity. Provinces and territories with small number of COVID-19 cases are expected to complete less tests per day.**


**Methods.** The number of tests completed per day is estimated by taking the difference between the cumulative number of tests on two consequtive days within each region. On days when no cumulative tests were reported, we carried forward the last observed value and treated all zero values of the consequtive cumulative tests' difference as missing. For example, 

The number of tests completed on March 25 in Ontario 

= the number of tests cumulative tests reported on March 26 in Ontario - the number of tests cumulative tests reported on March 25 in Ontario = 38550 - 	35635 = 2915.

On March 30, 2020 Ontario changed reporting thus causing the daily test estimate to be negative. We flagged it as missing (no point on the Ontario green curve on March 29th), when producing the below daily test plot.

<!-- made error reported alberta instead of ontario -->
```{r echo=FALSE}

#lead difference on cumulative tests between two consecutive dates within each province;
testing_cum <- testing_cum %>%
               group_by(Province) %>%
               mutate(lead_value = dplyr::lead(cumulative, n=1, default = NA))
testing_cum$est_daily<-testing_cum$lead_value - testing_cum$cumulative
testing_cum$est_daily2<-ifelse(testing_cum$est_daily<=0,NA, testing_cum$est_daily)

#Province plot;
testing_cum2<-subset(testing_cum, Province %in% c("AB","BC","MB","NB","NL","NS","ON","PE","QC","SK")& dateformat > as.Date("2020-03-19") & dateformat < as.Date("2020-04-08"))

testing_cum_top<-subset(testing_cum2, Province %in% c("AB","BC","ON","QC"))

topp<-ggplot(testing_cum_top, aes(x=dateformat, y=est_daily2, colour=Province)) +
  geom_point()+
  geom_line(data=testing_cum_top[!is.na(testing_cum_top$est_daily2),],size = 1)+
  scale_y_continuous(limits = c(0, 15300), breaks = seq(0,15300,2000))+
  scale_color_manual(values=teamcolour_province[c(1,2,7,9)])+
  scale_x_date(date_breaks="1 day",date_labels="%b %d", 
               limits = c(min(testing_cum2$dateformat), max(testing_cum2$dateformat) + 0.25)) +
  geom_hline(yintercept=3000, linetype="dashed", color = "black") +
  geom_hline(yintercept=5000, linetype="dashed", color = "black") +
  labs(y="\n Number of tests \n completed per day")+
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        panel.grid.major = element_line(colour = "grey95"),
        # panel.grid.minor = element_line(colour = "grey95"), 
        axis.text=element_text(size=11),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.title = element_blank(),
        legend.position =  "right",
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) 
# + geom_dl(aes(label = Province), method = list(dl.trans(x = x + 0.2), "last.qp")) #the end point is not the same having errors.


testing_cum_bot<-subset(testing_cum2, Province %in% c("MB","NB","NL","NS","PE","SK"))

botp<-ggplot(testing_cum_bot, aes(x=dateformat, y=est_daily2, colour=Province)) +
  geom_point()+
  geom_line(data=testing_cum_bot[!is.na(testing_cum_bot$est_daily2),],size = 1)+
  labs(y="\n Number of tests \n completed per day")+
  scale_y_continuous(limits = c(0, 1800), breaks = seq(0,1800,200))+
  scale_color_manual(values=teamcolour_province[c(3,4,5,6,8,10)])+
  scale_x_date(date_breaks="1 day",date_labels="%b %d", 
               limits = c(min(testing_cum2$dateformat), max(testing_cum2$dateformat) + 0.25)) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        panel.grid.major = element_line(colour = "grey95"),
        #panel.grid.minor = element_line(colour = "grey95"), 
        axis.title.x = element_blank(),
        # axis.title.y = element_blank(),
        axis.text=element_text(size=11),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.title = element_blank(),
        legend.position =  "right") 
# +geom_dl(aes(label = Province), method = list(dl.trans(x = x + 0.2), "last.qp")) #the end point is not the same having errors.


#Territory plot;
testing_cumt<-subset(testing_cum, Province %in% c("NU","YT","NT") & dateformat > as.Date("2020-03-19") & dateformat < as.Date("2020-04-08"))

terr<-ggplot(testing_cumt, aes(x=dateformat, y=est_daily2, colour=Province)) +
geom_line(data=testing_cumt[!is.na(testing_cumt$est_daily2),],size = 1)+geom_point()+
  scale_y_continuous(limits = c(0, 300), breaks = seq(0,300,50))+
  scale_color_manual(values=teamcolour_territory)+
  scale_x_date(date_breaks="1 day",date_labels="%b %d")+
  labs(y="\n Number of tests \n completed per day", x="")+
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        panel.grid.major = element_line(colour = "grey95"),
        #panel.grid.minor = element_line(colour = "grey95"), 
        axis.text=element_text(size=11),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.title = element_blank(),
        legend.position = "right",
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) 
# + geom_dl(aes(label = Province), method = list(dl.trans(x = x + 0.2), "last.qp"))

cowplot::plot_grid(topp, botp, terr, nrow=3,align = "v")

```

## 5. Testing results to date

- **Highlights**
  - **Nunavut has no confirmed case yet.**
  - **Quebec has the highest proportion of positive tests (9.4%).**
  - **There appears to be a back log of test reporting in Nunvaut. The back log in Ontario is observed to be cleared. The proportion of pending tests in Ontario has reduced significantly, at 1.4% now comparing to the same proportion on Mar 25, 2020 at 29.4%.**
  
```{r echo=FALSE}

testprop<-data.frame(testing_todate[,1],round(testing_todate[,4]/testing_todate[,5]*100,1),round(testing_todate[,3]/testing_todate[,5]*100,1),round(testing_todate[,2]/testing_todate[,5]*100,1))
names(testprop)<-c("province","pending","negative","positive")

testprop$negative<-ifelse(is.na(testprop$pending) & is.na(testprop$negative),100-testprop$positive, testprop$negative)
testprop_plot<-melt(testprop, id=c("province"))

ggplot(testprop_plot, aes(x = province, y = value, fill = variable, label = value)) +
  geom_bar(stat = "identity",width = 0.5, colour="black") +
  geom_text(size = 3, position = position_stack(vjust = 0.5),vjust=-1.2, na.rm=TRUE) + coord_flip() +
  scale_fill_manual(values = c("grey","springgreen2","red2"),name = "Test status", 
                    labels = c("Pending", "Negative", "Positive"))+
  labs(y="\n Percentage against total", x = "\n Test status by province and territory (%)", title=paste("As of ", format(Sys.time(), "%b %d, %Y %X")))+
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        panel.grid.major = element_line(colour = "white"),
        panel.grid.minor = element_line(colour = "white"), axis.text=element_text(size=11),
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)), 
        legend.position = "top", 
        axis.ticks.y = element_blank(), 
        panel.grid.major.x = element_line(colour = "grey94")) + 
  guides(fill = guide_legend(reverse=TRUE))

```


###### Footnote: For provinces that don't report pending cases, we will assume a binary testing status (postive or negative).

  
<!-- ### Important jurisdiction-specific dates -->

<!--   - March 22, 2020, Nova Scotia declared state of emergency -->
<!--   - March 20, 2020, Manitoba declares state of emergency -->
<!--   - March 20, 2020, Northwest Territories declared public health emergency -->
<!--   - March 19, 2020, New Brunswick declared state of emergency -->
<!--   - March 18, 2020, Newfoundland and Labrador declared public health emergency -->
<!--   - March 18, 2020, Yukon declared public health emergency -->
<!--   - March 18, 2020, Saskatchewan declared state of emergency -->
<!--   - March 18, 2020, British Columbia declared provintial state of emergency -->
<!--   - March 17, 2020, Nunavat declared public health emergency -->
<!--   - March 17, 2020, Alberta declared state of emergency -->
<!--   - March 17, 2020, Ontario declared state of emergency -->
<!--   - March 16, 2020, Prince Edward Island declared public health emergency -->
<!--   - March 13, 2020, Quebec declared health emergency -->


## Reference

- COVID-19 Canada Open Data Working Group. Epidemiological Data from the COVID-19 Outbreak in Canada. https://github.com/ishaberry/Covid19Canada. (2020-03-25).
- [National testing data to date] https://www.canada.ca/en/public-health/services/diseases/2019-novel-coronavirus-infection.html and https://www.ctvnews.ca/health/coronavirus/tracking-every-case-of-covid-19-in-canada-1.4852102
- [Ontario testing data to date] https://www.ontario.ca/page/2019-novel-coronavirus
- [British Columbia testing data to date] http://www.bccdc.ca/about/news-stories/stories/2020/information-on-novel-coronavirus
- [Alberta testing data to date] https://www.alberta.ca/covid-19-alberta-data.aspx
- [Saskatchewan testing data to date] https://www.saskatchewan.ca/government/health-care-administration-and-provider-resources/treatment-procedures-and-guidelines/emerging-public-health-issues/2019-novel-coronavirus/cases-and-risk-of-covid-19-in-saskatchewan()
- [Manitoba testing data to date] https://www.gov.mb.ca/covid19/
- [Quebec testing data to date] https://msss.gouv.qc.ca/professionnels/maladies-infectieuses/coronavirus-2019-ncov/
- [Newfoundland and Labrador testing data to date] https://www.gov.nl.ca/covid-19/
- [New Brunswick testing data to date] https://www2.gnb.ca/content/gnb/en/departments/ocmoh/cdc/content/respiratory_diseases/coronavirus.html
- [Nova Scotia testing data to date] https://novascotia.ca/coronavirus/#cases
- [Prince Edward Island testing data to date] https://www.princeedwardisland.ca/en/topic/covid-19
- [Yukon testing data to date] https://yukon.ca/en/health-and-wellness/health-concerns-diseases-and-conditions/covid-19-information
- [Northwest Territory testing data to date] https://www.hss.gov.nt.ca/en/services/coronavirus-disease-covid-19
- [Nunavut testing data to date] https://www.gov.nu.ca/health/information/covid-19-novel-coronavirus